# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Flip Moment is a Flutter decision-making app featuring multiple themed "skins" with interactive animations. Users flip coins or interact with various animated elements to make decisions, with gamification elements including experience points, levels, and unlockable themes.

## Build & Development Commands

```bash
# Install dependencies
flutter pub get

# Run code generation (required after modifying @freezed, @riverpod, or Hive models)
dart run build_runner build --delete-conflicting-outputs

# Watch mode for continuous code generation during development
dart run build_runner watch --delete-conflicting-outputs

# Run the app
flutter run

# Run tests
flutter test

# Run specific test file
flutter test test/audio_service_test.dart

# Analyze code
flutter analyze

# Clean build artifacts
flutter clean
```

## Core Architecture

### Skin Engine (Theme System)

The app uses a **protocol-oriented skin system** that allows swapping entire UI/UX experiences:

- **`AppSkin` protocol** (`lib/core/skin_engine/skin_protocol.dart`): Abstract interface defining all theming aspects (colors, fonts, animations, interactive components)
- **Skin implementations** (`lib/core/skins/`):
  - `VintageSkin`: Mechanical coin-flip with retro aesthetics
  - `HealingSkin`: Soft animations with Mochi character
  - `CyberSkin`: Futuristic HUD with liquid metal ball
  - `WishSkin`: Wish pond theme with water effects
- **`CurrentSkinProvider`** (`lib/core/skin_engine/skin_provider.dart`): Riverpod-based global state that persists skin selection to Hive

Each skin must implement `buildInteractiveHero()` which returns the main interactive widget (coin flipper, character, etc.).

### State Management

**Riverpod 2.x with code generation** is used throughout:

- Providers use `@riverpod` annotation (e.g., `skin_provider.dart`)
- Notifiers use `@Riverpod` class annotation
- Run `build_runner` after modifying any `@riverpod` annotated code
- Generated files: `*.g.dart`

Key providers:
- `currentSkinProvider`: Current active skin/theme
- `userProvider`: User data (level, exp, nickname)
- `decisionLogProvider`: Decision history
- `localeProvider`: i18n language selection

### Data Persistence

**Hive** is used for local storage:

- **Boxes opened in `main.dart`**:
  - `user_box`: Stores `UserModel` (includes error recovery logic)
  - `decisions_box`: Stores `DecisionModel` records
  - `settings_box`: Generic settings (skin preference, etc.)

- **Type adapters** registered in `main.dart`:
  - `UserModelAdapter` (generated by `@HiveType`)
  - `DecisionModelAdapter` (generated by `@HiveType`)

- Models use `@freezed` + `@HiveType` annotations (e.g., `user_model.dart`, `decision_model.dart`)

### Feature Architecture

Features follow **domain-driven structure**:

```
lib/features/{feature_name}/
  ├── data/          # Models (@freezed + @HiveType)
  ├── domain/        # Business entities (optional)
  ├── presentation/  # Screens & widgets
  └── providers/     # Riverpod state management
```

Key features:
- `decision`: Main coin-flip/decision interaction
- `history`: Decision history list
- `settings`: Profile, skin gallery, level progression
- `splash`: Initial loading screen

### Internationalization (i18n)

- Uses Flutter's built-in `gen_l10n` system
- ARB files: `lib/l10n/app_*.arb` (English, Chinese)
- Generated: `lib/l10n/app_localizations*.dart`
- Access via: `AppLocalizations.of(context)!`
- Skin names/descriptions are localized through `SkinModeX` extension methods

### Animation & Visual System

- **Rive animations**: Used in `HealingSkin` for Mochi character
- **Frame-based animations**: `FrameCoinFlipper` loads sequential PNG frames for vintage coin flip
- **Flutter Animate**: Declarative micro-interactions
- **Image cache tuning**: `main.dart` sets cache to 400MB/200 images to prevent frame drops during playback

### Audio & Haptics

- **`AudioService`** (`lib/core/services/audio/`): Manages sound effects per skin mode
  - Sounds: `flip`, `result`, `levelUp`
  - Asset path: `assets/audio/`
- **`HapticService`** (`lib/core/services/haptics/`): Platform-appropriate haptic feedback
  - Methods: `light()`, `medium()`, `heavy()`, `success()`

## Important Conventions

### Code Generation Workflow

When modifying any file with `@freezed`, `@riverpod`, or `@HiveType`:

1. Make changes to the annotated class
2. Run `dart run build_runner build --delete-conflicting-outputs`
3. Commit both source file and generated `*.g.dart` file

### Skin Development

To add a new skin:

1. Add enum value to `SkinMode` in `skin_protocol.dart`
2. Extend `SkinModeX` with localized strings
3. Create new skin class implementing `AppSkin`
4. Implement `buildInteractiveHero()` with custom interactive widget
5. Add case to `_getSkinFromMode()` in `skin_provider.dart`
6. Create corresponding audio assets in `assets/audio/{skin_mode}/`

### Decision Flow

The decision interaction follows this lifecycle:

1. User taps interactive hero (coin, character, etc.)
2. Component plays animation and determines result
3. `onResult` callback fires with result string ("正面"/"反面", etc.)
4. `DecisionScreen._handleDecisionEnd()`:
   - Plays result audio
   - Logs decision to history
   - Awards 10 XP to user
   - Shows `ResultCard`
5. User closes result card → triggers level-up dialog if applicable

### Gamification System

- **XP Awards**:
  - Per decision: 10 XP
  - First daily flip: +50 XP
  - Streak bonus: +5 XP per consecutive day (max +50)
  - Share action: 100 XP

- **Level progression**:
  - Formula: `maxExpForNextLevel = 100 + (level - 1) * 50`
  - Levels unlock titles (see `UserModel.getTitleLabel()`)
  - Premium skins unlock at specific levels

### Asset Management

- Images: `assets/images/`
  - Coin animation frames: `assets/images/coin_anim/`
- Audio: `assets/audio/`
- Update `pubspec.yaml` assets section when adding new files

### Localization Workflow

1. Add keys to `lib/l10n/app_en.arb` (source language)
2. Add translations to `lib/l10n/app_zh.arb`
3. Run `flutter gen-l10n` (happens automatically with `flutter run`)
4. Access via `AppLocalizations.of(context)!.keyName`

## Testing

- Test files in `test/` directory
- Existing tests:
  - `audio_service_test.dart`: Audio playback verification
  - `username_generator_test.dart`: Random name generation
  - `widget_test.dart`: Basic widget smoke tests

## Platform-Specific Notes

- **Android**: Umeng SDK initialized for analytics (`main.dart:66`)
- **iOS**: Google Fonts require internet on first load (cached thereafter)
- **Permissions**: Microphone (for blow detection in wish mode via `noise_meter`)
- **Sensors**: Gyroscope/accelerometer used for tilt interactions (`sensors_plus`)
