æ­å–œï¼ğŸ‰ æ—¢ç„¶ä»£ç å·²ç»ç¼–è¯‘é€šè¿‡ï¼Œè¯´æ˜æˆ‘ä»¬çš„**â€œå¤šç»´æ„Ÿå®˜ç³»ç»Ÿâ€**éª¨æ¶å·²ç»æ­å»ºå®Œæ¯•ã€‚

ç°åœ¨ï¼Œåªå·®æœ€åä¸€æ­¥ï¼š**æ³¨å…¥çµé­‚**ï¼ˆæ›¿æ¢çœŸå®éŸ³é¢‘æ–‡ä»¶ï¼‰ä»¥åŠ**èµ‹äºˆç”¨æˆ·æ§åˆ¶æƒ**ï¼ˆå¼€å…³è®¾ç½®ï¼‰ã€‚

ä½œä¸ºä¸€ä¸ªè¿½æ±‚å®Œç¾çš„ **Flutter Master**ï¼Œæˆ‘å¿…é¡»æé†’ä½ ï¼š**ä¸è¦è®©ç”¨æˆ·åœ¨å¼€ä¼šæ—¶å› ä¸ºè¯¯è§¦å‘å‡ºå·¨å¤§çš„â€œBoingâ€å£°è€Œå°´å°¬**ã€‚å› æ­¤ï¼Œå®ç°ä¸€ä¸ª**å…¨å±€è®¾ç½®ï¼ˆSettingsï¼‰æ¥æ§åˆ¶éŸ³æ•ˆå’Œéœ‡åŠ¨æ˜¯ä¸Šçº¿å‰çš„å¿…é€‰é¡¹**ã€‚

è¿™æ˜¯æˆ‘ä»¬æœ€åçš„å†²åˆºï¼

------



### ğŸ“ 1. èµ„æºå½’ä½æ£€æŸ¥ (Asset Checklist)



è¯·ç¡®ä¿ä½ æ‰¾åˆ°çš„éŸ³é¢‘æ–‡ä»¶å·²ç»æŒ‰ç…§ä»¥ä¸‹å‘½åè§„èŒƒï¼Œæ”¾å…¥äº† `assets/audio/` ç›®å½•ï¼š

| **çš®è‚¤ (Prefix)** | **åŠ¨ä½œ (Suffix)** | **æ–‡ä»¶åç¤ºä¾‹**       | **æ¨èå¬æ„Ÿ**                         |
| ----------------- | ----------------- | -------------------- | ------------------------------------ |
| **vintage**       | **tap**           | `vintage_tap.mp3`    | æ¸…è„†çš„é‡‘å±ç¡¬å¸æ’å‡»å£° (Clink)         |
|                   | **result**        | `vintage_result.mp3` | è€å¼ç›¸æœºå¿«é—¨æˆ–æ‰“å­—æœºå£° (Click-Clack) |
| **healing**       | **tap**           | `healing_tap.mp3`    | åƒæˆ³æœå†»ä¸€æ ·çš„è½¯èŒå£° (Boing/Squish)  |
|                   | **result**        | `healing_result.mp3` | æŸ”å’Œçš„é£é“ƒæˆ–ç«–ç´å£° (Chime)           |
| **cyber**         | **tap**           | `cyber_tap.mp3`      | é«˜é¢‘ç”µæµå……èƒ½å£° (Charge Up)           |
|                   | **result**        | `cyber_result.mp3`   | ç”µå­æ•…éšœéŸ³æˆ–é‡ä½éŸ³ (Glitch/Bass)     |
| **wish**          | **tap**           | `wish_tap.mp3`       | ç‰©ä½“è½å…¥æ°´ä¸­çš„å£°éŸ³ (Splash)          |
|                   | **result**        | `wish_result.mp3`    | ç©ºçµçš„å›å£°æˆ–é­”æ³•éŸ³æ•ˆ (Magic)         |

**åˆ«å¿˜äº†æ£€æŸ¥ `pubspec.yaml`:**

YAML

```
flutter:
  assets:
    - assets/audio/
```

------



### âš™ï¸ 2. æ„å»ºå…¨å±€è®¾ç½®ç³»ç»Ÿ (Settings System)



æˆ‘ä»¬å°†å®ç°ä¸€ä¸ª `SettingsProvider` æ¥ç®¡ç†â€œéŸ³æ•ˆâ€å’Œâ€œéœ‡åŠ¨â€çš„å¼€å…³ï¼Œå¹¶åˆ©ç”¨ Hive æŒä¹…åŒ–ä¿å­˜ï¼Œä¸‹æ¬¡æ‰“å¼€ App ä¾ç„¶ç”Ÿæ•ˆã€‚



#### A. è®¾ç½®çŠ¶æ€ç®¡ç† (`SettingsProvider`)



æ–°å»ºæ–‡ä»¶ï¼š`lib/features/settings/presentation/providers/settings_provider.dart`

Dart

```
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:hive_flutter/hive_flutter.dart';

class AppSettings {
  final bool isSoundOn;
  final bool isHapticOn;

  const AppSettings({this.isSoundOn = true, this.isHapticOn = true});

  AppSettings copyWith({bool? isSoundOn, bool? isHapticOn}) {
    return AppSettings(
      isSoundOn: isSoundOn ?? this.isSoundOn,
      isHapticOn: isHapticOn ?? this.isHapticOn,
    );
  }
}

class SettingsNotifier extends Notifier<AppSettings> {
  late Box _box;
  static const _kSoundKey = 'setting_sound_on';
  static const _kHapticKey = 'setting_haptic_on';

  @override
  AppSettings build() {
    _box = Hive.box('settings_box'); // ç¡®ä¿ main.dart é‡Œå·²ç» openBox('settings_box')
    return AppSettings(
      isSoundOn: _box.get(_kSoundKey, defaultValue: true),
      isHapticOn: _box.get(_kHapticKey, defaultValue: true),
    );
  }

  void toggleSound(bool value) {
    _box.put(_kSoundKey, value);
    state = state.copyWith(isSoundOn: value);
  }

  void toggleHaptic(bool value) {
    _box.put(_kHapticKey, value);
    state = state.copyWith(isHapticOn: value);
  }
}

final settingsProvider = NotifierProvider<SettingsNotifier, AppSettings>(SettingsNotifier.new);
```

------



### ğŸ® 3. å‡çº§æœåŠ¡å±‚ (Service Upgrade)



æˆ‘ä»¬éœ€è¦ä¿®æ”¹ `AudioService` å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„ `HapticService`ï¼Œè®©å®ƒä»¬èƒ½å¤Ÿ**è¯»å–è®¾ç½®**ï¼Œä»è€Œå†³å®šæ˜¯å¦çœŸçš„æ‰§è¡Œæ“ä½œã€‚



#### A. å‡çº§ `AudioService` (æ³¨å…¥ Ref)



ä¿®æ”¹ `lib/core/services/audio/audio_service.dart`ï¼š

Dart

```
// ... imports
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../features/settings/presentation/providers/settings_provider.dart'; // å¼•å…¥è®¾ç½®

// ... SoundType Enum ...

class AudioService {
  final AudioPlayer _player = AudioPlayer();
  final Ref _ref; // æ³¨å…¥ Riverpod Ref

  AudioService(this._ref) {
    // ... AudioContext é…ç½®ä¿æŒä¸å˜ ...
  }

  // ç§»é™¤å†…éƒ¨çš„ _isMuted å˜é‡ï¼Œæ”¹ç”¨ Provider
  // void toggleMute() ... ç§»é™¤

  Future<void> play(SoundType type, SkinMode mode) async {
    // ğŸ” æ ¸å¿ƒä¿®æ”¹ï¼šæ£€æŸ¥å…¨å±€è®¾ç½®
    final isSoundOn = _ref.read(settingsProvider).isSoundOn;
    if (!isSoundOn) return; 

    // ... åŸæœ‰æ’­æ”¾é€»è¾‘ ...
  }
  
  // ... _resolvePath ä¿æŒä¸å˜ ...
}

// âš ï¸ ä¿®æ”¹ Provider å®šä¹‰ï¼šæ³¨å…¥ ref
final audioServiceProvider = Provider<AudioService>((ref) {
  return AudioService(ref);
});
```



#### B. åˆ›å»º `HapticService` (ç»Ÿä¸€ç®¡ç†éœ‡åŠ¨)



ä¸ºäº†è®©éœ‡åŠ¨ä¹Ÿèƒ½è¢«å¼€å…³æ§åˆ¶ï¼Œæˆ‘ä»¬å°è£…ä¸€ä¸ªæœåŠ¡ï¼Œè€Œä¸æ˜¯åˆ°å¤„å†™ `HapticFeedback`ã€‚

æ–°å»ºæ–‡ä»¶ï¼š`lib/core/services/haptics/haptic_service.dart`

Dart

```
import 'package:flutter/services.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../features/settings/presentation/providers/settings_provider.dart';

class HapticService {
  final Ref _ref;

  HapticService(this._ref);

  // æ£€æŸ¥å¼€å…³
  bool get _canVibrate => _ref.read(settingsProvider).isHapticOn;

  Future<void> light() async {
    if (_canVibrate) await HapticFeedback.lightImpact();
  }

  Future<void> medium() async {
    if (_canVibrate) await HapticFeedback.mediumImpact();
  }

  Future<void> heavy() async {
    if (_canVibrate) await HapticFeedback.heavyImpact();
  }

  Future<void> selection() async {
    if (_canVibrate) await HapticFeedback.selectionClick();
  }
}

final hapticServiceProvider = Provider<HapticService>((ref) => HapticService(ref));
```

------



### ğŸ”Œ 4. æ›¿æ¢æ—§ä»£ç  (Refactoring)



ç°åœ¨ä½ éœ€è¦å…¨å±€æœç´¢ `HapticFeedback`ï¼ŒæŠŠå®ƒæ›¿æ¢ä¸º `ref.read(hapticServiceProvider).xxx()`ã€‚

**ç¤ºä¾‹ï¼šä¿®æ”¹ `CoinFlipper` (`lib/features/decision/presentation/widgets/coin_flipper.dart`)**

Dart

```
// ... imports
import '../../../../core/services/haptics/haptic_service.dart'; // å¼•å…¥

// ... inside _flip()
void _flip() {
  if (_controller.isAnimating) return;

  // ğŸµ æ’­æ”¾å£°éŸ³ (å·²æ”¯æŒå¼€å…³)
  ref.read(audioServiceProvider).play(SoundType.tap, widget.skin.mode);

  // ğŸ“³ è§¦å‘éœ‡åŠ¨ (ä¿®æ”¹ä¸º Service è°ƒç”¨)
  ref.read(hapticServiceProvider).heavy(); 

  widget.onFlipStart?.call();
  // ...
}
```

*(è¯·å¯¹ `MochiCharacter`, `LiquidMetalBall`, `DecisionScreen` ç­‰æ–‡ä»¶åšåŒæ ·çš„æ›¿æ¢)*

------



### ğŸ“± 5. è®¾ç½®é¡µé¢å®ç° (Settings Screen)



æœ€åï¼Œæˆ‘ä»¬åœ¨â€œæˆ‘çš„â€é¡µé¢é‡ŒåŠ ä¸€ä¸ªå…¥å£ï¼Œæˆ–è€…ç›´æ¥åœ¨â€œæˆ‘çš„â€é¡µé¢ä¸‹æ–¹å±•ç¤ºè¿™ä¸¤ä¸ªå¼€å…³ã€‚æ ¹æ®ä¹‹å‰çš„ iOS é£æ ¼ UIï¼Œæˆ‘ä»¬åœ¨ `MyProfileScreen` çš„â€œé€šç”¨è®¾ç½®â€ç»„é‡Œæ·»åŠ è¿™ä¸¤ä¸ªå¼€å…³æœ€åˆé€‚ã€‚

ä¿®æ”¹ `lib/features/settings/presentation/my_profile_screen.dart`ï¼š

Dart

```
// ... imports
import 'providers/settings_provider.dart'; // å¼•å…¥è®¾ç½® Provider

// ... inside build()
// è·å–è®¾ç½®çŠ¶æ€
final settings = ref.watch(settingsProvider);
final settingsNotifier = ref.read(settingsProvider.notifier);

// ... åœ¨ "é€šç”¨è®¾ç½®" (sectionGeneral) ä¸‹æ–¹ ...
_buildInsetGroup(
  children: [
    // ğŸ”Š éŸ³æ•ˆå¼€å…³
    _buildSwitchTile(
      icon: Icons.volume_up_rounded,
      iconBgColor: const Color(0xFF007AFF), // iOS Blue
      title: "Sound Effects", // å»ºè®®æ”¾å…¥ l10n
      value: settings.isSoundOn,
      onChanged: (val) => settingsNotifier.toggleSound(val),
    ),
    _buildDivider(),
    // ğŸ“³ éœ‡åŠ¨å¼€å…³
    _buildSwitchTile(
      icon: Icons.vibration_rounded,
      iconBgColor: const Color(0xFFFF9500), // iOS Orange
      title: "Haptic Feedback", // å»ºè®®æ”¾å…¥ l10n
      value: settings.isHapticOn,
      onChanged: (val) => settingsNotifier.toggleHaptic(val),
    ),
    _buildDivider(),
    // åŸæœ‰çš„ "è®¾ç½®ä¸æ›´å¤š"
    _buildListTile(
      icon: Icons.settings,
      iconBgColor: const Color(0xFF8E8E93),
      title: loc.settingGeneral,
      onTap: () {},
    ),
  ],
),
```

**è¡¥å…… `_buildSwitchTile` æ–¹æ³•ï¼š**

Dart

```
Widget _buildSwitchTile({
  required IconData icon,
  required Color iconBgColor,
  required String title,
  required bool value,
  required ValueChanged<bool> onChanged,
}) {
  return Container(
    padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
    child: Row(
      children: [
        Container(
          width: 28, height: 28,
          decoration: BoxDecoration(
            color: iconBgColor,
            borderRadius: BorderRadius.circular(6),
          ),
          child: Icon(icon, size: 16, color: Colors.white),
        ),
        const SizedBox(width: 14),
        Expanded(
          child: Text(
            title,
            style: GoogleFonts.inter(fontSize: 16, fontWeight: FontWeight.w500, color: kTextPrimary),
          ),
        ),
        // iOS é£æ ¼ Switch
        Switch.adaptive(
          value: value,
          onChanged: onChanged,
          activeColor: const Color(0xFF34C759), // iOS Green
        ),
      ],
    ),
  );
}
```



