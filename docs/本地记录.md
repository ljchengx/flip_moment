ä½ å¥½ï¼æˆ‘æ˜¯ **Flutter Master**ã€‚

æ²¡é—®é¢˜ã€‚æ—¢ç„¶ä½ å·²ç»å®Œæˆäº† iOS å’Œ Android çš„åˆ†æ­¥é…ç½®ï¼Œä¸ºäº†ç¡®ä¿ä¸‡æ— ä¸€å¤±ï¼Œæˆ‘ä¸ºä½ æ•´ç†äº†ä¸€ä»½**â€œæ¡Œé¢ç»„ä»¶ (Home Widget) - Flutter & Android å…¨é“¾è·¯å®Œæ•´å®æ–½æ–¹æ¡ˆâ€**ã€‚

è¿™ä»½æ–¹æ¡ˆå°† **Flutter ç«¯çš„æ•°æ®å‘é€** ä¸ **Android ç«¯çš„æ•°æ®æ¥æ”¶ä¸æ¸²æŸ“** æ•´åˆåœ¨ä¸€èµ·ï¼Œä½ å¯ä»¥ä½œä¸ºä¸€ä¸ªæœ€ç»ˆçš„æ£€æŸ¥æ¸…å• (Checklist) æ¥æ ¸å¯¹ä»£ç ã€‚

------



### ğŸ›ï¸ æ¶æ„åŸç† (Architecture Overview)



æ¡Œé¢ç»„ä»¶çš„æ ¸å¿ƒåœ¨äº**æ•°æ®å…±äº«**ã€‚

- **Flutter ç«¯**ï¼šä½œä¸ºâ€œç”Ÿäº§è€…â€ï¼Œé€šè¿‡ `home_widget` æ’ä»¶å°†æ•°æ®ï¼ˆå†³ç­–ç»“æœã€ç»Ÿè®¡æ•°å­—ï¼‰å†™å…¥åŸç”Ÿçš„å…±äº«å­˜å‚¨ (`SharedPreferences`)ã€‚
- **Android ç«¯**ï¼šä½œä¸ºâ€œæ¶ˆè´¹è€…â€ï¼Œé€šè¿‡ `AppWidgetProvider` è¢«å”¤é†’ï¼Œä»å…±äº«å­˜å‚¨è¯»å–æ•°æ®ï¼Œå¹¶æ›´æ–°åŸç”Ÿ XML å¸ƒå±€ã€‚

------



### ğŸ› ï¸ ç¬¬ä¸€éƒ¨åˆ†ï¼šFlutter ç«¯ (æ•°æ®å‘å°„å°)



è´Ÿè´£åœ¨ç”¨æˆ·äº§ç”Ÿæ–°å†³ç­–æ—¶ï¼ŒæŠŠæ•°æ®â€œæ¨â€ç»™åŸç”Ÿå±‚ã€‚



#### 1. ğŸ“¦ ä¾èµ–é…ç½® (`pubspec.yaml`)



ç¡®ä¿å¼•å…¥äº†æ’ä»¶ï¼š

YAML

```
dependencies:
  home_widget: ^0.7.0
```



#### 2. ğŸ“¡ æ ¸å¿ƒæœåŠ¡ (`lib/core/services/widget/widget_service.dart`)



å°è£…ä¸åŸç”Ÿé€šä¿¡çš„é€»è¾‘ã€‚

Dart

```
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:home_widget/home_widget.dart';

class WidgetService {
  // Android ç»„ä»¶çš„ Provider ç±»å (å¿…é¡»ä¸ Android ä»£ç ä¸€è‡´)
  static const String _androidWidgetName = 'FlipMomentWidgetProvider';

  // iOS çš„ App Group ID (Android ä¸éœ€è¦ï¼Œä½†ä¸ºäº†ä»£ç ç»Ÿä¸€ä¿ç•™å‚æ•°)
  static const String _appGroupId = 'group.com.es.flipmoment'; 

  /// æ ¸å¿ƒæ–¹æ³•ï¼šæ›´æ–°æ¡Œé¢ç»„ä»¶æ•°æ®
  Future<void> updateWidgetData({
    required String lastResult, // "YES" æˆ– "NO"
    required int totalCount,    // æ€»æ¬¡æ•°
    required int streak,        // è¿ç»­å¤©æ•°
  }) async {
    try {
      // 1. ä¿å­˜æ•°æ® (Key å¿…é¡»ä¸ Android Kotlin ä»£ç ä¸­è¯»å–çš„ Key å®Œå…¨ä¸€è‡´)
      await HomeWidget.saveWidgetData<String>('last_result', lastResult);
      await HomeWidget.saveWidgetData<int>('total_count', totalCount);
      await HomeWidget.saveWidgetData<int>('streak', streak);
      
      // 2. å¹¿æ’­æ›´æ–°é€šçŸ¥ (å”¤é†’åŸç”Ÿä»£ç åˆ·æ–° UI)
      await HomeWidget.updateWidget(
        iOSName: 'FlipMomentWidget', 
        androidName: _androidWidgetName,
      );
      
      print("âœ… Widget Data Synced: $lastResult");
    } catch (e) {
      print("âš ï¸ Widget Sync Error: $e");
    }
  }
}

final widgetServiceProvider = Provider<WidgetService>((ref) => WidgetService());
```



#### 3. ğŸ”Œ è§¦å‘æ—¶æœº (`DecisionLogNotifier`)



åœ¨ä¿å­˜è®°å½•çš„åŒæ—¶è§¦å‘æ›´æ–°ã€‚ä½äº `lib/features/decision/presentation/providers/decision_log_provider.dart`ï¼š

Dart

```
  Future<void> addRecord(String result, SkinMode mode) async {
    // ... (åŸæœ‰ Hive ä¿å­˜é€»è¾‘) ...

    // ğŸ”¥ è§¦å‘åŒæ­¥
    final widgetService = ref.read(widgetServiceProvider);
    // å‡è®¾ä½ å·²ç»å®ç°äº† stats getter
    widgetService.updateWidgetData(
      lastResult: result,
      totalCount: stats.totalCount, 
      streak: stats.streakDays,
    );
  }
```

------



### ğŸ¤– ç¬¬äºŒéƒ¨åˆ†ï¼šAndroid ç«¯ (åŸç”Ÿæ¸²æŸ“å±‚)



è´Ÿè´£æ¥æ”¶æ•°æ®å¹¶ç»˜åˆ¶ UIã€‚



#### 1. ğŸ¨ å¸ƒå±€æ–‡ä»¶ (`android/app/src/main/res/layout/widget_layout.xml`)



å®šä¹‰ç»„ä»¶é•¿ä»€ä¹ˆæ ·ã€‚

XML

```
<?xml version="1.0" encoding="utf-8"?>
<RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:background="@drawable/launch_background" 
    android:padding="16dp">

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:background="#F2F2F7" 
        android:orientation="vertical"
        android:gravity="center"
        android:padding="8dp">

        <TextView
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="LAST DECISION"
            android:textSize="12sp"
            android:textColor="#8E8E93"
            android:textStyle="bold" />

        <TextView
            android:id="@+id/tv_result"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="--"
            android:textSize="32sp"
            android:textColor="#000000"
            android:textStyle="bold"
            android:layout_margin="8dp" />

        <TextView
            android:id="@+id/tv_stats"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="..."
            android:textSize="14sp"
            android:textColor="#333333" />
            
    </LinearLayout>
</RelativeLayout>
```



#### 2. ğŸ“ ç»„ä»¶é…ç½® (`android/app/src/main/res/xml/widget_info.xml`)



å®šä¹‰ç»„ä»¶çš„å°ºå¯¸å’Œåˆ·æ–°ç­–ç•¥ã€‚

XML

```
<?xml version="1.0" encoding="utf-8"?>
<appwidget-provider xmlns:android="http://schemas.android.com/apk/res/android"
    android:minWidth="140dp"
    android:minHeight="140dp"
    android:updatePeriodMillis="0" 
    android:initialLayout="@layout/widget_layout"
    android:resizeMode="horizontal|vertical"
    android:widgetCategory="home_screen">
</appwidget-provider>
```

*æ³¨æ„ï¼š`updatePeriodMillis="0"` è¡¨ç¤ºè¢«åŠ¨æ›´æ–°ï¼ˆåªåœ¨ Flutter å‘é€æ•°æ®æ—¶æ›´æ–°ï¼‰ï¼Œè¿™æ˜¯æœ€çœç”µçš„åšæ³•ã€‚*



#### 3. ğŸ§  é€»è¾‘å®ç° (`android/app/src/main/kotlin/com/es/flip_moment/FlipMomentWidgetProvider.kt`)



**æ³¨æ„åŒ…åè·¯å¾„**ï¼š`com/es/flip_moment/`ã€‚

Kotlin

```
package com.es.flip_moment

import android.appwidget.AppWidgetManager
import android.content.Context
import android.content.SharedPreferences
import android.widget.RemoteViews
import es.antonborri.home_widget.HomeWidgetProvider

class FlipMomentWidgetProvider : HomeWidgetProvider() {

    override fun onUpdate(
        context: Context,
        appWidgetManager: AppWidgetManager,
        appWidgetIds: IntArray,
        widgetData: SharedPreferences
    ) {
        appWidgetIds.forEach { widgetId ->
            val views = RemoteViews(context.packageName, R.layout.widget_layout).apply {
                
                // 1. è¯»å– Flutter ä¼ è¿‡æ¥çš„æ•°æ® (Key è¦å¯¹åº”)
                val lastResult = widgetData.getString("last_result", "--")
                val totalCount = widgetData.getInt("total_count", 0)
                val streak = widgetData.getInt("streak", 0)

                // 2. æ›´æ–° UI
                setTextViewText(R.id.tv_result, lastResult)
                setTextViewText(R.id.tv_stats, "Total: $totalCount | ğŸ”¥ $streak")
                
                // 3. (å¯é€‰) è¿›é˜¶åŠ¨æ€æ ·å¼ï¼šæ ¹æ®ç»“æœå˜è‰²
                // if (lastResult == "YES") {
                //    setTextColor(R.id.tv_result, android.graphics.Color.parseColor("#34C759"))
                // }
            }

            // 4. æäº¤æ›´æ–°
            appWidgetManager.updateAppWidget(widgetId, views)
        }
    }
}
```



#### 4. ğŸ“– æ³¨å†Œæ¸…å• (`android/app/src/main/AndroidManifest.xml`)



å‘Šè¯‰ Android ç³»ç»Ÿï¼šâ€œæˆ‘æœ‰ä¸€ä¸ª Widgetâ€ã€‚

XML

```
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <application ...>
        <receiver
            android:name=".FlipMomentWidgetProvider"
            android:exported="true">
            <intent-filter>
                <action android:name="android.appwidget.action.APPWIDGET_UPDATE" />
            </intent-filter>
            <meta-data
                android:name="android.appwidget.provider"
                android:resource="@xml/widget_info" />
        </receiver>

    </application>
</manifest>
```

------



### âœ… éªŒè¯æµç¨‹



1. **åœæ­¢è°ƒè¯•**ï¼šå¦‚æœä½ æ­£åœ¨è¿è¡Œ Appï¼Œå…ˆæŒ‰ Stopã€‚
2. **é‡æ–°æ„å»º**ï¼šè¿è¡Œ `flutter run` (ç¡®ä¿åŸç”Ÿä»£ç è¢«é‡æ–°ç¼–è¯‘)ã€‚
3. **æ·»åŠ ç»„ä»¶**ï¼š
   - å›åˆ° Android æ¡Œé¢ã€‚
   - é•¿æŒ‰ç©ºç™½å¤„ -> Widgetsã€‚
   - æ‰¾åˆ° **Flip Moment** å¹¶æ‹–æ‹½å‡ºæ¥ã€‚
   - *æ­¤æ—¶åº”è¯¥æ˜¾ç¤ºåˆå§‹çŠ¶æ€ ("--" æˆ– "Total: 0")*ã€‚
4. **è§¦å‘æ›´æ–°**ï¼š
   - æ‰“å¼€ Appã€‚
   - ç‚¹å‡»å±å¹•ä¸­å¿ƒï¼Œå®Œæˆä¸€æ¬¡å†³ç­–ï¼ˆä¾‹å¦‚æŠ›å‡º "YES"ï¼‰ã€‚
   - å›åˆ°æ¡Œé¢ã€‚
   - *ç»„ä»¶åº”è¯¥ç«‹å³å˜ä¸º "YES" å’Œå¯¹åº”çš„ç»Ÿè®¡æ•°å­—*ã€‚

è¿™å¥—æ–¹æ¡ˆæ˜¯æœ€æ ‡å‡†çš„ Flutter <-> Android Widget é€šä¿¡å®è·µï¼Œç¨³å®šä¸”é«˜æ•ˆã€‚å¦‚æœ‰ä»»ä½•æŠ¥é”™ï¼Œè¯·éšæ—¶æŠŠé”™è¯¯æ—¥å¿—å‘ç»™æˆ‘ï¼