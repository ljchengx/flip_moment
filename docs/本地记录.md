

### ğŸ—ï¸ 1. æ ¸å¿ƒè®¾è®¡æ€è·¯ (Design Overview)



æˆ‘ä»¬å°†æ•°æ®å±‚åˆ†ä¸ºä¸¤ä¸ªæ ¸å¿ƒ Domainï¼š

1. **User Domain**: è´Ÿè´£ç®¡ç†â€œä¸´æ—¶ç”¨æˆ·â€èº«ä»½ã€‚ç¦»çº¿æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬åœ¨ App é¦–æ¬¡å¯åŠ¨æ—¶ç”Ÿæˆä¸€ä¸ª UUID ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼Œå¹¶å­˜å‚¨ç”¨æˆ·çš„ç­‰çº§ã€ç»éªŒå€¼ç­‰å…ƒæ•°æ®ã€‚
2. **Decision Domain**: è´Ÿè´£å­˜å‚¨æ¯ä¸€æ¬¡çš„å†³ç­–è®°å½•ï¼ˆLogï¼‰ã€‚

**æ•°æ®ç»“æ„è®¾è®¡ï¼š**

- **Box 1: `user_box`** (å•ä¾‹å­˜å‚¨)
  - å­—æ®µï¼š`uid` (String), `nickname` (String), `level` (int), `exp` (int), `createdAt` (DateTime).
- **Box 2: `decisions_box`** (åˆ—è¡¨å­˜å‚¨)
  - å­—æ®µï¼š`id` (String), `timestamp` (DateTime), `result` (String: YES/NO), `skinMode` (String), `mood` (int, optional).

------



### ğŸ› ï¸ 2. æ•°æ®æ¨¡å‹å±‚ (Data Layer)



è¯·åœ¨ `lib/features` ä¸‹æ–°å»ºå¯¹åº”çš„æ•°æ®æ¨¡å‹æ–‡ä»¶ã€‚æˆ‘ä»¬éœ€è¦ä½¿ç”¨ `hive_generator` æ¥ç”Ÿæˆé€‚é…å™¨ä»£ç ã€‚



#### A. å†³ç­–è®°å½•æ¨¡å‹



æ–°å»ºæ–‡ä»¶ï¼š`lib/features/decision/data/decision_model.dart`

Dart

```
import 'package:hive/hive.dart';
import '../../../core/skin_engine/skin_protocol.dart'; // å¼•ç”¨ SkinMode

part 'decision_model.g.dart'; // ç­‰å¾… build_runner ç”Ÿæˆ

@HiveType(typeId: 1) // åˆ†é…å”¯ä¸€çš„ typeId
class DecisionModel extends HiveObject {
  @HiveField(0)
  final String id;

  @HiveField(1)
  final DateTime timestamp;

  @HiveField(2)
  final String result; // "YES" or "NO"

  @HiveField(3)
  final String skinModeName; // å­˜å‚¨ SkinMode.name

  DecisionModel({
    required this.id,
    required this.timestamp,
    required this.result,
    required this.skinModeName,
  });

  // è¾…åŠ©å·¥å‚ï¼šæ–¹ä¾¿ä»ä¸šåŠ¡é€»è¾‘åˆ›å»º
  factory DecisionModel.create({
    required String result,
    required SkinMode skinMode,
  }) {
    return DecisionModel(
      id: DateTime.now().millisecondsSinceEpoch.toString(), // ç®€æ˜“ID
      timestamp: DateTime.now(),
      result: result,
      skinModeName: skinMode.name,
    );
  }
}
```



#### B. ç”¨æˆ·æ¡£æ¡ˆæ¨¡å‹



æ–°å»ºæ–‡ä»¶ï¼š`lib/features/settings/data/user_model.dart` (æˆ–è€…æ”¾åœ¨ `lib/core/user/` ä¸‹)

Dart

```
import 'package:hive/hive.dart';

part 'user_model.g.dart';

@HiveType(typeId: 0)
class UserModel extends HiveObject {
  @HiveField(0)
  final String uid;

  @HiveField(1)
  String nickname;

  @HiveField(2)
  int level;

  @HiveField(3)
  int totalFlips; // å†—ä½™å­—æ®µï¼Œæ–¹ä¾¿å¿«é€Ÿè¯»å–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŸ¥è¯¢ decisions_box è®¡ç®—

  UserModel({
    required this.uid,
    this.nickname = "Traveler",
    this.level = 1,
    this.totalFlips = 0,
  });
}
```

> âš ï¸ é‡è¦æç¤ºï¼š å†™å®Œä¸Šè¿°ä»£ç åï¼Œè¯·åœ¨ç»ˆç«¯è¿è¡Œä»£ç ç”Ÿæˆå‘½ä»¤ï¼š
>
> flutter pub run build_runner build --delete-conflicting-outputs

------



### ğŸ§  3. çŠ¶æ€ç®¡ç†å±‚ (State Management / Providers)



æˆ‘ä»¬å°†ä½¿ç”¨ **Riverpod** çš„ `NotifierProvider` æ¥å°è£… Hive çš„è¯»å†™æ“ä½œï¼Œå¯¹å¤–æš´éœ²å¹²å‡€çš„æ¥å£ã€‚



#### A. å†³ç­–å­˜å‚¨ Provider (DecisionRepository)



æ–°å»ºæ–‡ä»¶ï¼š`lib/features/decision/presentation/providers/decision_log_provider.dart`

è¿™ä¸ª Provider è´Ÿè´£ä¸¤ä»¶äº‹ï¼š

1. **å†™å…¥**ï¼šå½“ç”¨æˆ·å®Œæˆäº’åŠ¨æ—¶ï¼Œä¿å­˜è®°å½•ã€‚
2. **ç»Ÿè®¡**ï¼šè®¡ç®—æ€»æ¬¡æ•°ã€è¿ç»­å¤©æ•°ã€å¿«ä¹ç‡ã€‚

Dart

```
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:hive_flutter/hive_flutter.dart';
import '../../../../core/skin_engine/skin_protocol.dart';
import '../../data/decision_model.dart';

// å®šä¹‰ä¸€ä¸ªç®€å•çš„ç»Ÿè®¡ç±»
class DecisionStats {
  final int totalCount;
  final int streakDays;
  final double happyRate;

  DecisionStats({this.totalCount = 0, this.streakDays = 0, this.happyRate = 0.0});
}

// --- Notifier ---
class DecisionLogNotifier extends Notifier<List<DecisionModel>> {
  late Box<DecisionModel> _box;

  @override
  List<DecisionModel> build() {
    // åˆå§‹åŒ–æ—¶æ‰“å¼€ Box (æ³¨æ„ï¼šHive.init å¿…é¡»åœ¨ main ä¸­å…ˆå®Œæˆ)
    _box = Hive.box<DecisionModel>('decisions_box');
    
    // è¿”å›æŒ‰æ—¶é—´å€’åºæ’åˆ—çš„åˆ—è¡¨
    final list = _box.values.toList();
    list.sort((a, b) => b.timestamp.compareTo(a.timestamp));
    return list;
  }

  // â• æ–°å¢è®°å½•
  Future<void> addRecord(String result, SkinMode mode) async {
    final newRecord = DecisionModel.create(result: result, skinMode: mode);
    await _box.add(newRecord);
    
    // åˆ·æ–°çŠ¶æ€
    state = [newRecord, ...state];
  }

  // ğŸ“Š è·å–ç»Ÿè®¡æ•°æ® (è¿™æ˜¯ä¸ª Computed Property é€»è¾‘)
  DecisionStats get stats {
    if (state.isEmpty) return DecisionStats();

    // 1. æ€»æ•°
    final total = state.length;

    // 2. å¿«ä¹ç‡ (YES çš„å æ¯”)
    final yesCount = state.where((e) => e.result == "YES").length;
    final rate = total == 0 ? 0.0 : (yesCount / total * 100);

    // 3. è¿ç»­æ‰“å¡å¤©æ•° (Streak) - ç®€åŒ–ç‰ˆç®—æ³•
    // å®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„æ—¥å†é€»è¾‘
    int streak = 0;
    final today = DateTime.now();
    // ...è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„è¿ç»­å¤©æ•°è®¡ç®—é€»è¾‘...
    // æš‚æ—¶è¿”å› Mock æ•°æ®æˆ–ç®€å•è®¡ç®—
    streak = state.isNotEmpty ? 1 : 0; 

    return DecisionStats(totalCount: total, streakDays: streak, happyRate: rate);
  }
}

// --- Provider ---
final decisionLogProvider = NotifierProvider<DecisionLogNotifier, List<DecisionModel>>(
  DecisionLogNotifier.new,
);
```



#### B. ç”¨æˆ·èº«ä»½ Provider (UserProvider)



æ–°å»ºæ–‡ä»¶ï¼š`lib/features/settings/presentation/providers/user_provider.dart`

è´Ÿè´£ç®¡ç†â€œä¸´æ—¶ç”¨æˆ·â€ã€‚å¦‚æœ Box é‡Œæ²¡æ•°æ®ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„ï¼›å¦‚æœæœ‰ï¼Œå°±åŠ è½½ã€‚

Dart

```
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:hive_flutter/hive_flutter.dart';
import 'package:uuid/uuid.dart';
import '../../data/user_model.dart';

class UserNotifier extends Notifier<UserModel> {
  late Box<UserModel> _box;

  @override
  UserModel build() {
    _box = Hive.box<UserModel>('user_box');
    
    if (_box.isEmpty) {
      // âœ¨ é¦–æ¬¡å¯åŠ¨ï¼šåˆ›å»ºä¸´æ—¶ç”¨æˆ·
      final newUser = UserModel(
        uid: const Uuid().v4(),
        nickname: "Fate Traveler", // é»˜è®¤æ˜µç§°
      );
      _box.put('current_user', newUser);
      return newUser;
    } else {
      // ğŸ“‚ åŠ è½½å·²æœ‰ç”¨æˆ·
      return _box.get('current_user')!;
    }
  }

  // æ›´æ–°ç­‰çº§ (Gamification)
  void incrementExp() {
    // ç”±äº HiveObject æ˜¯å¯å˜çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä¿®æ”¹å¹¶ save
    // ä½†ä¸ºäº†è§¦å‘ Riverpod æ›´æ–°ï¼Œå»ºè®®ç”Ÿæˆæ–°å¯¹è±¡æˆ–å¼ºåˆ¶åˆ·æ–°
    state.level += 1; // ç®€åŒ–é€»è¾‘ï¼šæ¯æ¬¡æ“ä½œå‡ä¸€çº§
    state.save(); 
    
    // å¼ºåˆ¶é€šçŸ¥ç›‘å¬è€…
    ref.notifyListeners();
  }
}

final userProvider = NotifierProvider<UserNotifier, UserModel>(UserNotifier.new);
```

------



### ğŸ”Œ 4. å…¨å±€åˆå§‹åŒ– (Main Entry)



æˆ‘ä»¬éœ€è¦ä¿®æ”¹ `lib/main.dart`ï¼Œåœ¨ App å¯åŠ¨å‰æ³¨å†Œ Adapter å¹¶æ‰“å¼€ Boxã€‚

ä¿®æ”¹ `lib/main.dart`:

Dart

```
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:hive_flutter/hive_flutter.dart';

// Models
import 'features/decision/data/decision_model.dart';
import 'features/settings/data/user_model.dart';

import 'core/providers/locale_provider.dart';
import 'l10n/app_localizations.dart';
import 'features/decision/presentation/decision_screen.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // 1. Hive åˆå§‹åŒ–
  await Hive.initFlutter();

  // 2. æ³¨å†Œ Adapters (ç”± build_runner ç”Ÿæˆ)
  Hive.registerAdapter(UserModelAdapter());
  Hive.registerAdapter(DecisionModelAdapter());

  // 3. æ‰“å¼€ Boxes (åŒæ­¥ç­‰å¾…ï¼Œç¡®ä¿ App å¯åŠ¨æ—¶æ•°æ®å°±ç»ª)
  await Hive.openBox<UserModel>('user_box');
  await Hive.openBox<DecisionModel>('decisions_box');
  // Settings box å·²ç»åœ¨ locale_provider é‡Œå¤„ç†äº†ï¼Œå»ºè®®ç»Ÿä¸€åœ¨è¿™é‡Œæ‰“å¼€
  await Hive.openBox('settings_box'); 

  runApp(
    const ProviderScope(
      child: FlipMomentApp(),
    ),
  );
}

// FlipMomentApp ç±»ä¿æŒä¸å˜...
```

------



### ğŸ“± 5. ç•Œé¢é›†æˆ (UI Integration)



æœ€åï¼Œæˆ‘ä»¬å°†é€»è¾‘æ¥å…¥åˆ°ç°æœ‰çš„ UI ä¸­ã€‚



#### A. ä¿®æ”¹ `DecisionScreen` - è®°å½•æ“ä½œ



ä½ç½®ï¼š`lib/features/decision/presentation/decision_screen.dart`

åœ¨ `_handleDecisionEnd` æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ Provider ä¿å­˜æ•°æ®ã€‚

Dart

```
// ... imports
import '../providers/decision_log_provider.dart'; // å¼•å…¥ Provider
import '../../settings/presentation/providers/user_provider.dart'; // å¼•å…¥ User Provider

// ... inside _DecisionScreenState

  void _handleDecisionEnd(String result) {
    // 1. ğŸ’¾ ä¿å­˜è®°å½•åˆ°æœ¬åœ°æ•°æ®åº“
    // æ­¤æ—¶ skin å˜é‡å·²ç»åœ¨ build æ–¹æ³•ä¸­è·å–äº†
    final skin = ref.read(currentSkinProvider); // æˆ–è€…åœ¨ build é‡Œè·å–çš„ skin
    
    // è°ƒç”¨ Notifier ä¿å­˜
    ref.read(decisionLogProvider.notifier).addRecord(result, skin.mode);

    // 2. ğŸ†™ (å¯é€‰) å¢åŠ ç”¨æˆ·ç»éªŒå€¼/è§¦å‘å‡çº§é€»è¾‘
    ref.read(userProvider.notifier).incrementExp();

    // 3. åŸæœ‰ UI é€»è¾‘ï¼šå»¶è¿Ÿå¼¹å‡ºç»“æœå¡ç‰‡
    Future.delayed(const Duration(milliseconds: 300), () {
      if (mounted) {
        setState(() {
          _currentResult = result;
          _showResult = true;
        });
      }
    });
  }
```



#### B. ä¿®æ”¹ `MyProfileScreen` - å±•ç¤ºçœŸå®æ•°æ®



ä½ç½®ï¼š`lib/features/settings/presentation/my_profile_screen.dart`

å°†å†™æ­»çš„ `"108"`, `"7"`, `"Lv.5"` æ›¿æ¢ä¸º Provider çš„æ•°æ®ã€‚

Dart

```
// ... imports
import '../../decision/presentation/providers/decision_log_provider.dart'; // ç»Ÿè®¡æ•°æ®
import 'providers/user_provider.dart'; // ç”¨æˆ·æ•°æ®

class MyProfileScreen extends ConsumerWidget {
  // ... constants

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final skin = ref.watch(currentSkinProvider);
    final loc = AppLocalizations.of(context)!;
    
    // ğŸ”„ ç›‘å¬å®æ—¶æ•°æ®
    final user = ref.watch(userProvider);
    final decisionNotifier = ref.watch(decisionLogProvider.notifier); // è·å– notifier ä»¥è®¿é—® getter
    // æ³¨æ„ï¼šä¸ºäº†è®© stats å˜åŒ–æ—¶åˆ·æ–°ï¼Œæœ€å¥½æŠŠ DecisionStats å°è£…æˆå•ç‹¬çš„ Providerï¼Œ
    // æˆ–è€…ç®€å•åœ°ç›‘å¬ decisionLogProvider (List å˜åŒ–æ—¶é‡ç»˜) å¹¶é‡æ–°è®¡ç®— statsã€‚
    ref.watch(decisionLogProvider); // ç›‘å¬åˆ—è¡¨å˜åŒ–
    final stats = decisionNotifier.stats; // è·å–æœ€æ–°ç»Ÿè®¡

    return Scaffold(
      // ... AppBar ...
      body: SingleChildScrollView(
        child: Column(
          children: [
            // ... Title ...

            // --- ä¿®æ”¹ Identity Section ---
            _buildIdentitySection(skin, loc, user, stats),

            // ...
          ],
        ),
      ),
    );
  }

  // æ›´æ–°æ–¹æ³•ç­¾åï¼Œä¼ å…¥ user å’Œ stats
  Widget _buildIdentitySection(
      AppSkin skin, 
      AppLocalizations loc, 
      UserModel user, 
      DecisionStats stats
  ) {
    return Container(
      // ... decoration ...
      child: Column(
        children: [
          _buildHeroAvatar(skin),
          const SizedBox(height: 16),

          // 1. æ˜¾ç¤ºçœŸå®æ˜µç§°
          Text(
            user.nickname, 
            style: GoogleFonts.inter(fontSize: 22, fontWeight: FontWeight.w700, color: kTextPrimary),
          ),
          const SizedBox(height: 4),
          
          // 2. æ˜¾ç¤ºçœŸå®ç­‰çº§
          Text(
            "Lv.${user.level} ${loc.identityTitle.split(' ').last}", // ç®€å•çš„å­—ç¬¦ä¸²å¤„ç†ï¼Œä¿ç•™ "Fate Navigator"
            style: GoogleFonts.inter(fontSize: 13, fontWeight: FontWeight.w500, color: Colors.blueAccent),
          ),

          // ... Divider ...

          // 3. æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceAround,
            children: [
              _buildStatItem(stats.totalCount.toString(), loc.statsFlips),
              _buildStatItem(stats.streakDays.toString(), loc.statsStreak),
              _buildStatItem("${stats.happyRate.toStringAsFixed(0)}%", loc.statsHappy),
            ],
          ),
        ],
      ),
    );
  }
```



### âœ… æ€»ç»“



è¿™å¥—æ–¹æ¡ˆå®Œç¾å¥‘åˆä½ ç°æœ‰çš„æ¶æ„ï¼š

1. **Clean Architecture**: æ•°æ®æ¨¡å‹ (Data)ã€é€»è¾‘ (Notifier)ã€UI (Presentation) åˆ†ç¦»æ¸…æ™°ã€‚
2. **Offline First**: åŸºäº Hiveï¼Œæ— éœ€ç½‘ç»œï¼Œä¸”æ•°æ®æŒä¹…åŒ–ã€‚
3. **Reactive**: åˆ©ç”¨ Riverpodï¼Œå½“ä½ åšå®Œä¸€ä¸ªå†³å®šï¼Œ`MyProfileScreen` çš„æ•°æ®ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œæ— éœ€æ‰‹åŠ¨åˆ·æ–°ã€‚

ç°åœ¨ï¼Œä½ å¯ä»¥æŒ‰ç…§æ­¥éª¤åˆ›å»ºæ–‡ä»¶å¹¶è¿è¡Œ `build_runner` äº†ã€‚å¦‚æœæœ‰ä»»ä½•ç”Ÿæˆé”™è¯¯ï¼Œè¯·å‘Šè¯‰æˆ‘ã€‚