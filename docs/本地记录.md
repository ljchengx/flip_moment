ä½ å¥½ï¼æˆ‘æ˜¯ **Flutter Master**ã€‚

æ”¶åˆ°ã€‚æ—¢ç„¶å»æ‰â€œè¯¯åˆ æ¢å¤â€è¿™ä¸ªéæ ¸å¿ƒéœ€æ±‚ï¼Œæˆ‘ä»¬çš„æ¶æ„ä¼šæ›´åŠ è½»é‡å’Œçº¯ç²¹ã€‚

é’ˆå¯¹ **â€œå¤šç»´æ„Ÿå®˜ç³»ç»Ÿâ€ (Audio Service Architecture)**ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ„å»ºä¸€ä¸ª**ä½è€¦åˆã€å¯æ’æ‹”ã€æ”¯æŒå¤šä¸»é¢˜å·®å¼‚åŒ–**çš„éŸ³é¢‘æœåŠ¡å±‚ã€‚

è¿™ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒæŒ‘æˆ˜åœ¨äºï¼š**UI å±‚ (Widget) ä¸åº”è¯¥å…³å¿ƒâ€œæ’­æ”¾å“ªä¸ªæ–‡ä»¶â€ï¼Œå®ƒåªåº”è¯¥å‘å‡ºâ€œæ„å›¾â€ (Intent)**ï¼Œä¾‹å¦‚ï¼šâ€œæˆ‘è¢«ç‚¹å‡»äº†â€æˆ–â€œç»“æœå‡ºæ¥äº†â€ã€‚å…·ä½“çš„éŸ³æ•ˆæ–‡ä»¶åº”è¯¥ç”± `AudioService` ç»“åˆå½“å‰çš„ `SkinMode` åŠ¨æ€å†³ç­–ã€‚

------



### ğŸ—ï¸ 1. æ¶æ„è®¾è®¡ (Architecture Design)



æˆ‘ä»¬å°†é‡‡ç”¨ **Service Locator (æœåŠ¡å®šä½)** æ¨¡å¼ï¼Œåˆ©ç”¨ Riverpod æä¾›çš„å…¨å±€å•ä¾‹æ¥ç®¡ç†éŸ³é¢‘æ’­æ”¾å™¨ã€‚

**æ ¸å¿ƒç»„ä»¶ï¼š**

1. **`SoundType` (Enum)**: å®šä¹‰å¬è§‰æ„å›¾ (ç‚¹å‡»ã€ç»“æœã€èƒŒæ™¯éŸ³)ã€‚
2. **`AudioService` (Class)**: å°è£…åº•å±‚ `audioplayers` åº“ï¼Œå¤„ç†æ–‡ä»¶æ˜ å°„ã€å¹¶å‘æ§åˆ¶å’Œé™éŸ³é€»è¾‘ã€‚
3. **`AudioProvider`**: å…¨å±€æ³¨å…¥ç‚¹ã€‚

------



### ğŸ› ï¸ 2. æœåŠ¡å±‚å®ç° (Service Implementation)



è¯·æ–°å»ºæ–‡ä»¶ï¼š`lib/core/services/audio/audio_service.dart`

è¿™ä¸ªæœåŠ¡ä¼šè‡ªåŠ¨æ ¹æ®ä¼ å…¥çš„ `SkinMode` å¯»æ‰¾å¯¹åº”çš„éŸ³é¢‘æ–‡ä»¶ã€‚

Dart

```
import 'package:audioplayers/audioplayers.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../skin_engine/skin_protocol.dart';

/// å®šä¹‰å¬è§‰æ„å›¾
enum SoundType {
  tap,      // äº¤äº’è§¦å‘ (ç‚¹å‡»/è“„åŠ›/æ‹‰åŠ¨)
  result,   // ç»“æœæ­æ™“ (æˆåŠŸ/å‡ºç°)
  special,  // ç‰¹æ®ŠéŸ³æ•ˆ (å¦‚èµ›åšæ•…éšœå£°ã€è®¸æ„¿æ± çš„é£é“ƒ)
}

class AudioService {
  // ä½¿ç”¨å•ä¸ªæ’­æ”¾å™¨å¤„ç†çŸ­éŸ³æ•ˆï¼Œå¦‚æœéœ€è¦é«˜å¹¶å‘(å¦‚å¿«é€Ÿç‚¹å‡»)ï¼Œå¯è€ƒè™‘ä½¿ç”¨ Soundpool
  // ä½†å¯¹äº audioplayers 6.0+ï¼ŒAudioPlayer åœ¨ä½å»¶è¿Ÿæ¨¡å¼ä¸‹è¡¨ç°å·²è¶³å¤Ÿå¥½
  final AudioPlayer _player = AudioPlayer();

  // é™éŸ³çŠ¶æ€ (æœªæ¥å¯å¯¹æ¥ SettingsProvider)
  bool _isMuted = false;

  AudioService() {
    // åˆå§‹åŒ–é…ç½®ï¼šè®¾ç½®éŸ³é¢‘ä¸Šä¸‹æ–‡
    final AudioContext audioContext = const AudioContext(
      iOS: AudioContextIOS(
        category: AVAudioSessionCategory.ambient, // å…è®¸ä¸å…¶ä»–éŸ³ä¹æ··éŸ³
      ),
      android: AudioContextAndroid(
        isSpeakerphoneOn: true,
        stayAwake: false,
        contentType: AndroidContentType.sonification,
        usageType: AndroidUsageType.assistanceSonification,
        audioFocus: AndroidAudioFocus.none,
      ),
    );
    AudioPlayer.global.setAudioContext(audioContext);
  }

  void toggleMute() {
    _isMuted = !_isMuted;
    if (_isMuted) _player.stop();
  }

  /// æ ¸å¿ƒæ’­æ”¾æ–¹æ³•
  /// [type]: åŠ¨ä½œç±»å‹
  /// [mode]: å½“å‰çš®è‚¤æ¨¡å¼
  Future<void> play(SoundType type, SkinMode mode) async {
    if (_isMuted) return;

    // 1. åŠ¨æ€è§£æèµ„æºè·¯å¾„
    final assetPath = _resolvePath(type, mode);
    if (assetPath == null) return;

    try {
      // 2. åœæ­¢ä¸Šä¸€æ®µå£°éŸ³ (é¿å…é‡å æ‚ä¹±ï¼Œå¯è§†éœ€æ±‚è°ƒæ•´ä¸ºå¹¶å‘)
      if (type == SoundType.result) {
        await _player.stop(); 
      }
      
      // 3. æ’­æ”¾ (AssetSource ä¼šè‡ªåŠ¨æŸ¥æ‰¾ assets/)
      // audioplayers 6.x å†™æ³•
      await _player.play(AssetSource(assetPath), volume: 1.0);
      
    } catch (e) {
      // ç”Ÿäº§ç¯å¢ƒå»ºè®®æ¥å…¥ Crashlyticsï¼Œå¼€å‘ç¯å¢ƒæ‰“å°å³å¯
      print("âš ï¸ Audio Playback Error: $e");
    }
  }

  /// è·¯å¾„æ˜ å°„é€»è¾‘
  /// çº¦å®šèµ„æºå‘½åè§„èŒƒï¼šassets/audio/{skin}_{type}.mp3
  String? _resolvePath(SoundType type, SkinMode mode) {
    // å°†æšä¸¾è½¬ä¸ºå­—ç¬¦ä¸²å‰ç¼€: vintage, healing, cyber, wish
    final String prefix = mode.name; 
    
    // å°†åŠ¨ä½œè½¬ä¸ºåç¼€
    final String suffix = type.name; 

    // æœ€ç»ˆè·¯å¾„ç¤ºä¾‹: "audio/vintage_tap.mp3"
    return "audio/${prefix}_${suffix}.mp3";
  }
}

// å…¨å±€ Provider
final audioServiceProvider = Provider<AudioService>((ref) {
  return AudioService();
});
```

------



### ğŸ¨ 3. èµ„æºå‡†å¤‡ (Asset Checklist)



**è¿™ä¸€æ­¥è‡³å…³é‡è¦**ã€‚ä»£ç å†™å¾—å†å¥½ï¼Œæ²¡æœ‰æ–‡ä»¶ä¹Ÿæ˜¯å“‘å·´ã€‚ä½ éœ€è¦å‡†å¤‡ä»¥ä¸‹ `.mp3` æˆ– `.wav` æ–‡ä»¶ï¼Œå¹¶æ”¾å…¥ `assets/audio/` ç›®å½•ï¼š

**å¤å¤æœºæ¢° (Vintage):**

- `vintage_tap.mp3`: é‡‘å±ç¡¬å¸çš„æ¸…è„†æ’å‡»å£° (Clink)ã€‚
- `vintage_result.mp3`: è€å¼ç›¸æœºçš„å¿«é—¨å£°æˆ–æ‰“å­—æœºçš„æ¢è¡Œå£°ã€‚

**æ²»æ„ˆå›¢å­ (Healing):**

- `healing_tap.mp3`: Qå¼¹çš„æœå†»å£° (Boing) æˆ– æ°”æ³¡å£° (Pop)ã€‚
- `healing_result.mp3`: æŸ”å’Œçš„é£é“ƒå£°æˆ–ç«–ç´æ»‘éŸ³ã€‚

**èµ›åšæœ‹å…‹ (Cyber):**

- `cyber_tap.mp3`: é«˜é¢‘ç”µæµå……ç”µå£° (Charge up)ã€‚
- `cyber_result.mp3`: ç”µå­æ•…éšœéŸ³ (Glitch) æˆ– é‡ä½éŸ³å†²å‡»ã€‚

**è®¸æ„¿æ±  (Wish):**

- `wish_tap.mp3`: æ°´æ»´å…¥æ°´å£° (Splash)ã€‚
- `wish_result.mp3`: ç©ºçµçš„å›å£°æˆ–é­”æ³•ç²‰æœ«éŸ³æ•ˆã€‚

**é…ç½® `pubspec.yaml`:**

YAML

```
flutter:
  assets:
    - assets/audio/  # ç¡®ä¿è¿™ä¸€è¡Œå­˜åœ¨
```

------



### ğŸ”Œ 4. æ·±åº¦é›†æˆ (Wiring Logic)



æˆ‘ä»¬éœ€è¦åœ¨ä¸¤ä¸ªå…³é”®èŠ‚ç‚¹æ³¨å…¥å£°éŸ³ï¼š

1. **äº¤äº’å¼€å§‹æ—¶ (Tap)**ï¼šåœ¨å„ä¸ª Hero Widget å†…éƒ¨ã€‚
2. **ç»“æœæ­æ™“æ—¶ (Result)**ï¼šåœ¨ `DecisionScreen` æ”¶åˆ°å›è°ƒæ—¶ã€‚



#### A. æ¥å…¥ `DecisionScreen` (å¤„ç† Result éŸ³æ•ˆ)



ä¿®æ”¹ `lib/features/decision/presentation/decision_screen.dart`:

Dart

```
// 1. å¼•å…¥ Service
import '../../../../core/services/audio/audio_service.dart';

// ... inside _DecisionScreenState

  void _handleDecisionEnd(String result) {
    // è·å–å½“å‰çš®è‚¤å’ŒéŸ³é¢‘æœåŠ¡
    final skin = ref.read(currentSkinProvider);
    final audioService = ref.read(audioServiceProvider);

    // ğŸµ æ’­æ”¾ç»“æœéŸ³æ•ˆ (æ ¸å¿ƒæ’å…¥ç‚¹)
    audioService.play(SoundType.result, skin.mode);

    // åŸæœ‰é€»è¾‘ï¼šä¿å­˜è®°å½•
    ref.read(decisionLogProvider.notifier).addRecord(result, skin.mode);
    
    // ...
  }
```



#### B. æ¥å…¥ `CoinFlipper` (å¤„ç† Tap éŸ³æ•ˆ)



ä¿®æ”¹ `lib/features/decision/presentation/widgets/coin_flipper.dart`:

Dart

```
// 1. å¼•å…¥
import 'package:flutter_riverpod/flutter_riverpod.dart'; // å¦‚æœä¹‹å‰æ˜¯ StatefulWidgetï¼Œéœ€è¦è½¬ä¸º ConsumerStatefulWidget
import '../../../../core/services/audio/audio_service.dart';

// 2. å°† StatefulWidget æ”¹ä¸º ConsumerStatefulWidget
class CoinFlipper extends ConsumerStatefulWidget { 
  // ... å‚æ•°ä¸å˜
}

class _CoinFlipperState extends ConsumerState<CoinFlipper> with SingleTickerProviderStateMixin { // State ä¹Ÿæ”¹
  
  // ... initState, dispose ä¸å˜

  void _flip() {
    if (_controller.isAnimating) return;

    // ğŸµ æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆ (æ ¸å¿ƒæ’å…¥ç‚¹)
    ref.read(audioServiceProvider).play(SoundType.tap, widget.skin.mode);

    widget.onFlipStart?.call();
    HapticFeedback.heavyImpact(); // è§†è§‰ã€å¬è§‰ã€è§¦è§‰åŒæ­¥è§¦å‘

    // ...åç»­åŠ¨ç”»é€»è¾‘ä¸å˜
  }
}
```



#### C. æ¥å…¥ `MochiCharacter` (å¤„ç† Tap éŸ³æ•ˆ)



ä¿®æ”¹ `lib/features/decision/presentation/widgets/mochi_character.dart`:

åŒæ ·çš„é€»è¾‘ï¼Œå°† `StatefulWidget` å‡çº§ä¸º `ConsumerStatefulWidget`ï¼Œç„¶ååœ¨ `_onTap` ä¸­æ’­æ”¾ã€‚

Dart

```
// ...
  void _onTap() {
    if (_isProcessing) return;
    
    // ğŸµ æ’­æ”¾ Q å¼¹éŸ³æ•ˆ
    ref.read(audioServiceProvider).play(SoundType.tap, widget.skin.mode);

    setState(() => _isProcessing = true);
    // ...
  }
// ...
```

*(ä»¥æ­¤ç±»æ¨ï¼Œå¯¹ `LiquidMetalBall` å’Œ `WishPond` åšåŒæ ·çš„å¤„ç†)*

------



### âœ… æ–¹æ¡ˆæ€»ç»“



1. **è§£è€¦**ï¼šUI ç»„ä»¶å®Œå…¨ä¸çŸ¥é“éŸ³é¢‘æ–‡ä»¶çš„å­˜åœ¨ï¼Œå®ƒä»¬åªè´Ÿè´£å–Šå‡º `play(SoundType.tap)`ã€‚
2. **å¯æ‰©å±•**ï¼šæœªæ¥å¦‚æœä½ åŠ äº†æ–°çš®è‚¤ï¼ˆæ¯”å¦‚ "åƒç´ é£"ï¼‰ï¼Œåªéœ€è¦æŠŠ `pixel_tap.mp3` ä¸¢è¿›æ–‡ä»¶å¤¹ï¼Œä¸éœ€è¦æ”¹ä»»ä½•ä¸€è¡Œä»£ç ã€‚
3. **å®¹é”™**ï¼šå¦‚æœæŸä¸ªçš®è‚¤å¿˜è®°æ”¾éŸ³æ•ˆæ–‡ä»¶ï¼Œ`AudioService` ä¼šä¼˜é›…åœ°å¿½ç•¥ï¼Œä¸ä¼šå´©æºƒã€‚

ç°åœ¨ï¼Œå»å¯»æ‰¾é‚£äº›çµé­‚éŸ³æ•ˆå¹¶å¡«å…¥ `assets/audio` å§ï¼è¿™å°±æ˜¯è®© App å˜å¾—é²œæ´»çš„å…³é”®ä¸€æ­¥ã€‚