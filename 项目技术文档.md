# Flip Moment - 项目技术文档

## 项目概述

Flip Moment 是一个基于 Flutter 开发的决策辅助应用，采用多主题皮肤系统，提供复古、治愈、赛博和许愿四种不同的视觉和交互体验。应用核心功能是帮助用户通过动画交互做出随机决策，同时保存历史记录。

### 项目基本信息
- **项目名称**: Flip Moment
- **项目类型**: Flutter 移动应用
- **版本**: 1.0.0+1
- **开发语言**: Dart
- **最低SDK版本**: Flutter 3.10.1
- **架构模式**: Feature-First + Layered Architecture（三层架构）

## 技术架构

### 架构模式

采用 **Feature-First + Layered Architecture** 架构模式，分为三层：

1. **Data Layer（数据层）**
   - 数据持久化和存储
   - Hive 数据库实现
   - 数据模型定义

2. **Domain Layer（领域层）**
   - 业务逻辑和实体
   - 状态管理
   - 核心业务规则

3. **Presentation Layer（表现层）**
   - UI 界面和交互
   - Flutter Widget
   - 用户交互处理

### 核心依赖分析

#### 🧠 核心架构
- `flutter_riverpod: ^2.5.1` - 主要状态管理解决方案
- `riverpod_annotation: ^2.3.5` - 代码生成注解，减少样板代码
- `freezed_annotation: ^2.4.1` - 不可变数据模型生成
- `go_router: ^13.2.0` - 声明式路由管理

#### 💾 数据持久化
- `hive: ^2.2.3` + `hive_flutter: ^1.1.0` - 高性能本地数据库
- `path_provider: ^2.1.2` - 获取系统存储路径

#### 🎨 视觉渲染引擎
- `rive: ^0.13.4` - 矢量动画运行时，治愈模式核心
- `flutter_animate: ^4.5.0` - 声明式动画库，用于微交互
- `google_fonts: ^6.2.1` - 动态加载字体

#### 🎮 硬件交互
- `sensors_plus: ^5.0.1` - 陀螺仪/加速度计支持
- `audioplayers: ^6.0.0` - 音效播放
- `noise_meter: ^5.0.0` - 麦克风音量检测（吹气检测）
- `permission_handler: ^11.3.0` - 权限管理

#### 🛠 代码生成工具
- `build_runner: ^2.4.9` - 代码生成工具
- `riverpod_generator: ^2.4.0` - Riverpod 代码生成
- `freezed: ^2.4.7` - 不可变数据类生成
- `hive_generator: ^2.0.1` - Hive 数据模型生成

## 目录结构分析

```
lib/
├── main.dart                 # 应用入口点
├── core/                     # 核心通用模块
│   ├── constants/           # 全局常量
│   ├── datebase/            # 数据库配置
│   ├── exceptions/          # 异常处理
│   ├── providers/           # 状态提供者
│   ├── services/            # 核心服务
│   ├── skin_engine/         # 皮肤引擎核心
│   │   ├── skin_protocol.dart      # 皮肤协议定义
│   │   ├── skin_provider.dart      # 皮肤状态管理
│   │   └── skin_provider.g.dart    # 代码生成文件
│   ├── skins/               # 皮肤实现
│   │   ├── vintage_skin.dart       # 复古风格
│   │   ├── healing_skin.dart       # 治愈风格
│   │   ├── cyber_skin.dart         # 赛博朋克风格
│   │   └── wish_skin.dart          # 许愿风格
│   ├── theme/               # 基础主题
│   ├── ui/                  # UI组件
│   └── utils/               # 工具类
├── features/                # 按功能划分
│   ├── decision/            # 决策功能
│   │   ├── data/            # 数据模型
│   │   ├── domain/          # 业务逻辑
│   │   ├── presentation/    # UI展示
│   │   └── providers/       # 状态管理
│   ├── history/             # 历史记录
│   ├── settings/            # 设置功能
│   ├── splash/              # 启动页面
│   └── user/                # 用户相关
├── services/                # 第三方服务封装
│   ├── audio/               # 音频服务
│   ├── haptics/             # 触感反馈
│   ├── storage/             # 存储服务
│   └── widget/              # 桌面组件
└── l10n/                    # 国际化文件
    ├── app_en.arb           # 英文语言包
    ├── app_zh.arb           # 中文语言包
    └── ...                  # 生成的本地化代码
```

## 核心功能模块

### 1. 多皮肤系统（Skin Engine）

#### 设计模式
采用**抽象工厂模式**实现完全解耦的皮肤系统：

- **核心协议**: `AppSkin` 接口定义所有皮肤必须实现的协议
- **皮肤实现**: 四种不同风格的皮肤实现
- **状态管理**: 通过 Riverpod 管理皮肤状态

#### 皮肤类型

1. **VintageSkin（复古风格）**
   - 设计理念：3D 硬币翻转动画，机械感强
   - 颜色：深灰色背景，金黄色强调色
   - 字体：Playfair Display（标题）+ Lato（正文）+ Courier Prime（数字）
   - 动画：使用序列帧硬币组件 `FrameCoinFlipper`

2. **HealingSkin（治愈风格）**
   - 设计理念：柔和的矢量动画（Rive）
   - 颜色：米白色背景，温和色调
   - 字体：舒适易读的字体组合
   - 动画：Rive 矢量动画

3. **CyberSkin（赛博朋克风格）**
   - 设计理念：科技感 UI
   - 颜色：黑色背景，高对比度强调色
   - 字体：未来感字体
   - 动画：科技感特效

4. **WishSkin（许愿风格）**
   - 设计理念：梦幻视觉效果
   - 颜色：渐变背景，温暖色调
   - 字体：优雅的字体选择
   - 动画：梦幻特效

#### 皮肤协议设计

```dart
abstract class AppSkin {
  // 基础标识
  SkinMode get mode;
  
  // 语义化颜色系统
  Color get backgroundSurface;
  Color get primaryAccent;
  Color get secondaryAccent;
  Color get textPrimary;
  
  // 语义化字体系统
  TextStyle get displayFont;
  TextStyle get bodyFont;
  TextStyle get monoFont;
  
  // 动态资源构建
  Widget buildInteractiveHero({
    required AnimationController controller,
    required VoidCallback onTap,
    Function(String)? onResult,
  });
  
  // 物理参数
  Curve get animationCurve;
  Duration get animationDuration;
}
```

### 2. 决策系统（Decision System）

#### 数据模型

```dart
@HiveType(typeId: 1)
class DecisionModel extends HiveObject {
  @HiveField(0)
  final String id;
  
  @HiveField(1)
  final DateTime timestamp;
  
  @HiveField(2)
  final String result;
  
  @HiveField(3)
  final String skinModeName;
}
```

#### 功能特性
- 随机决策生成
- 决策历史记录保存
- 按皮肤模式分类
- 决策结果回调机制

### 3. 数据持久化系统

#### Hive 数据库配置
- **用户数据**: `user_box` - 存储用户配置信息
- **决策数据**: `decisions_box` - 存储决策历史记录
- **设置数据**: `settings_box` - 存储应用设置

#### 数据适配器注册
```dart
Hive.registerAdapter(UserModelAdapter());
Hive.registerAdapter(DecisionModelAdapter());
```

### 4. 国际化支持

#### 配置
- **支持语言**: 中文 (zh)、英文 (en)
- **本地化委托**: 
  - `AppLocalizations.delegate` - 自定义本地化
  - `GlobalMaterialLocalizations.delegate`
  - `GlobalWidgetsLocalizations.delegate`
  - `GlobalCupertinoLocalizations.delegate`

#### 本地化文件
- `app_en.arb` - 英文语言包
- `app_zh.arb` - 中文语言包

### 5. 硬件交互系统

#### 触感反馈
- 使用 `HapticService` 实现触感反馈
- 支持多种触感模式

#### 音频系统
- 支持音效播放
- 不同皮肤拥有专属音效

#### 传感器支持
- 陀螺仪和加速度计支持
- 支持设备方向检测

## 性能优化

### 内存管理
- **图片缓存**: 最大缓存 200 张图片，400MB 容量
- **代码分割**: 按功能模块分离代码
- **资源管理**: 按需加载动画资源

### 资源优化
```dart
// 图片缓存配置
PaintingBinding.instance.imageCache.maximumSize = 200;
PaintingBinding.instance.imageCache.maximumSizeBytes = 400 * 1024 * 1024; // 400MB
```

### 错误处理
- 数据库异常处理和恢复机制
- 日志过滤和调试优化

## 第三方服务集成

### 友盟统计
```dart
UmengCommonSdk.initCommon('692822638560e34872f53c3d', '', 'Umeng');
UmengCommonSdk.setPageCollectionModeManual();
```

### 桌面组件
- 支持 Home Widget 集成
- 桌面小组件显示

## 构建和部署

### 开发环境要求
- Flutter SDK: >=3.10.1
- Dart SDK: >=3.10.1

### 构建命令
```bash
# 依赖安装
flutter pub get

# 代码生成
flutter packages pub run build_runner build

# 运行应用
flutter run

# 构建 APK
flutter build apk

# 构建 iOS
flutter build ios

# 运行测试
flutter test

# 代码分析
flutter analyze
```

## 开发规范

### 代码规范
- 使用 `flutter_lints` 进行代码检查
- 遵循 Dart 官方代码风格指南
- 使用 Riverpod 进行状态管理

### 状态管理
- 主要使用 **Riverpod** 作为状态管理方案
- 通过 `riverpod_generator` 进行代码生成
- 状态提供者统一管理在 `providers/` 目录下

### 资源管理
- 音频资源按皮肤分类存储在 `assets/audio/`
- 图片资源存储在 `assets/images/`
- 3D 模型资源存储在 `assets/models/`

## 项目特色

### 1. 多态皮肤系统
通过抽象工厂模式实现了完全解耦的皮肤系统，UI 组件只需要依赖 `AppSkin` 接口，不关心具体实现细节。

### 2. 声明式动画
使用 `flutter_animate` 库实现流畅的动画效果，每种皮肤都有独特的动画曲线和时长。

### 3. 响应式设计
支持不同屏幕尺寸的适配，确保在手机和平板上都有良好的用户体验。

### 4. 高性能本地存储
使用 Hive 实现高性能本地存储，支持结构化数据存储和查询。

### 5. 完整的硬件交互支持
集成音效、触感、传感器等多种硬件交互，提供沉浸式用户体验。

## 注意事项

### 资源管理
- 皮肤切换是资源密集型操作，需要做好资源管理和内存释放
- 音效文件需要根据当前皮肤预加载
- 动画控制器在不使用时需要及时释放

### 数据库操作
- 数据库操作应该在后台线程执行
- 提供数据库异常处理和恢复机制

### 权限处理
- 传感器和音频功能需要相应权限
- 使用 `permission_handler` 优雅处理权限请求

## 总结

Flip Moment 项目采用了现代化的 Flutter 开发最佳实践，通过清晰的分层架构、优秀的代码组织和丰富的功能模块，为用户提供了一个高质量的决策辅助应用。项目在技术选型、架构设计和用户体验方面都表现出色，是一个值得学习的 Flutter 项目范例。

---

*本文档基于项目代码结构分析生成，反映项目当前技术状态*